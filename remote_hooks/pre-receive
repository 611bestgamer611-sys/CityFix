#!/bin/bash

# CityFix Pre-Receive Hook
# Server-side hook that runs before accepting pushed commits

set -e

echo "üîç Server: Validating push..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Read stdin (old-rev, new-rev, ref-name)
while read oldrev newrev refname; do
    # Get branch name
    BRANCH=$(echo "$refname" | sed 's/refs\/heads\///')
    
    echo "Validating branch: $BRANCH"
    
    # Protect main/master branch
    if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
        # Check if this is a force push
        if [ "$oldrev" != "0000000000000000000000000000000000000000" ]; then
            # Check if old commit is ancestor of new commit (no force push)
            if ! git merge-base --is-ancestor "$oldrev" "$newrev"; then
                echo -e "${RED}‚ùå Force push to $BRANCH is not allowed${NC}"
                exit 1
            fi
        fi
        
        # Ensure commits are signed (optional)
        # Uncomment to enforce signed commits
        # COMMITS=$(git rev-list "$oldrev".."$newrev")
        # for commit in $COMMITS; do
        #     if ! git verify-commit "$commit" 2>/dev/null; then
        #         echo -e "${RED}‚ùå Commit $commit is not signed${NC}"
        #         echo "All commits to $BRANCH must be signed"
        #         exit 1
        #     fi
        # done
    fi
    
    # Validate commit messages
    COMMITS=$(git rev-list "$oldrev".."$newrev")
    
    for commit in $COMMITS; do
        MESSAGE=$(git log --format=%B -n 1 "$commit")
        SUBJECT=$(echo "$MESSAGE" | head -n1)
        
        # Skip merge commits
        if echo "$SUBJECT" | grep -q "^Merge"; then
            continue
        fi
        
        # Check conventional commits format
        PATTERN="^(feat|fix|docs|style|refactor|test|chore|perf|ci|build)(\([a-z0-9_-]+\))?: .{1,100}"
        
        if ! echo "$SUBJECT" | grep -qE "$PATTERN"; then
            echo -e "${RED}‚ùå Invalid commit message in $commit${NC}"
            echo "Message: $SUBJECT"
            echo "Commit messages must follow Conventional Commits format"
            exit 1
        fi
        
        # Check for prohibited content in commits
        DIFF=$(git diff-tree --no-commit-id --name-only -r "$commit")
        
        # Check file sizes
        for file in $DIFF; do
            if git cat-file -e "$newrev:$file" 2>/dev/null; then
                SIZE=$(git cat-file -s "$newrev:$file")
                # Reject files larger than 10MB
                if [ "$SIZE" -gt 10485760 ]; then
                    echo -e "${RED}‚ùå File too large: $file ($(($SIZE / 1024 / 1024))MB)${NC}"
                    echo "Maximum file size is 10MB"
                    echo "Consider using Git LFS for large files"
                    exit 1
                fi
            fi
        done
    done
    
    # Check for branch naming convention
    if ! echo "$BRANCH" | grep -qE "^(main|master|develop|feature/|bugfix/|hotfix/|release/)"; then
        echo -e "${YELLOW}‚ö†Ô∏è  Warning: Branch name '$BRANCH' doesn't follow naming convention${NC}"
        echo "Recommended: feature/, bugfix/, hotfix/, release/"
    fi
done

echo -e "${GREEN}‚úÖ Server validation passed${NC}"
exit 0

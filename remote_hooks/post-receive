#!/bin/bash

# CityFix Post-Receive Hook
# Server-side hook that triggers after successful push

set -e

echo "ðŸš€ Server: Processing push..."

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Configuration
CI_WEBHOOK_URL="${CI_WEBHOOK_URL:-}"
SLACK_WEBHOOK_URL="${SLACK_WEBHOOK_URL:-}"
PROJECT_NAME="CityFix"

# Read stdin (old-rev, new-rev, ref-name)
while read oldrev newrev refname; do
    # Get branch name
    BRANCH=$(echo "$refname" | sed 's/refs\/heads\///')
    
    echo -e "${BLUE}ðŸ“Œ Processing branch: $BRANCH${NC}"
    
    # Get commit information
    COMMIT_COUNT=$(git rev-list --count "$oldrev".."$newrev")
    AUTHOR=$(git log -1 --format='%an <%ae>' "$newrev")
    COMMIT_MSG=$(git log -1 --format='%s' "$newrev")
    COMMIT_HASH=$(git log -1 --format='%h' "$newrev")
    
    echo "  Commits: $COMMIT_COUNT"
    echo "  Author: $AUTHOR"
    echo "  Message: $COMMIT_MSG"
    
    # Trigger CI/CD pipeline
    if [ -n "$CI_WEBHOOK_URL" ]; then
        echo -e "${YELLOW}ðŸ”„ Triggering CI/CD pipeline...${NC}"
        
        PAYLOAD=$(cat <<EOF
{
  "repository": "$PROJECT_NAME",
  "branch": "$BRANCH",
  "commit": "$COMMIT_HASH",
  "message": "$COMMIT_MSG",
  "author": "$AUTHOR",
  "commits": $COMMIT_COUNT
}
EOF
)
        
        curl -X POST "$CI_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD" \
            --silent --output /dev/null || true
        
        echo -e "${GREEN}âœ… CI/CD pipeline triggered${NC}"
    fi
    
    # Send Slack notification
    if [ -n "$SLACK_WEBHOOK_URL" ]; then
        echo -e "${YELLOW}ðŸ’¬ Sending Slack notification...${NC}"
        
        SLACK_PAYLOAD=$(cat <<EOF
{
  "text": "ðŸš€ New push to $PROJECT_NAME",
  "blocks": [
    {
      "type": "section",
      "text": {
        "type": "mrkdwn",
        "text": "*Push to $PROJECT_NAME*\n*Branch:* \`$BRANCH\`\n*Commits:* $COMMIT_COUNT\n*Author:* $AUTHOR\n*Message:* $COMMIT_MSG"
      }
    }
  ]
}
EOF
)
        
        curl -X POST "$SLACK_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$SLACK_PAYLOAD" \
            --silent --output /dev/null || true
        
        echo -e "${GREEN}âœ… Slack notification sent${NC}"
    fi
    
    # Auto-deploy to staging for develop branch
    if [ "$BRANCH" = "develop" ]; then
        echo -e "${YELLOW}ðŸš€ Auto-deploying to staging...${NC}"
        
        # Add deployment logic here
        # Example:
        # ssh user@staging-server "cd /opt/cityfix && git pull && docker-compose up -d --build"
        
        echo -e "${GREEN}âœ… Deployed to staging${NC}"
    fi
    
    # Auto-deploy to production for main/master branch (with caution)
    if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
        echo -e "${YELLOW}ðŸŽ¯ Production branch detected${NC}"
        echo "Consider triggering production deployment via CI/CD"
        
        # Usually production deploys should be manual or through proper CI/CD
        # Uncomment with extreme caution:
        # ssh user@prod-server "cd /opt/cityfix && git pull && docker-compose up -d --build"
    fi
    
    # Create backup of production deployment
    if [ "$BRANCH" = "main" ] || [ "$BRANCH" = "master" ]; then
        BACKUP_DIR="${BACKUP_DIR:-/var/backups/cityfix}"
        if [ -d "$BACKUP_DIR" ]; then
            BACKUP_NAME="cityfix-$BRANCH-$COMMIT_HASH-$(date +%Y%m%d-%H%M%S).tar.gz"
            echo -e "${YELLOW}ðŸ’¾ Creating backup: $BACKUP_NAME${NC}"
            # Add backup logic here
            echo -e "${GREEN}âœ… Backup created${NC}"
        fi
    fi
    
    echo -e "${GREEN}âœ… Post-receive processing completed${NC}"
done

exit 0
